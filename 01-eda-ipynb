{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "afda771e",
   "metadata": {
    "_cell_guid": "b1076dfc-b9ad-4769-8c92-a6c4dae69d19",
    "_uuid": "8f2839f25d086af736a60e9eeb907d3b93b6e0e5",
    "execution": {
     "iopub.execute_input": "2025-12-31T16:17:00.875164Z",
     "iopub.status.busy": "2025-12-31T16:17:00.874837Z",
     "iopub.status.idle": "2025-12-31T16:17:00.881632Z",
     "shell.execute_reply": "2025-12-31T16:17:00.880536Z"
    },
    "papermill": {
     "duration": 0.013791,
     "end_time": "2025-12-31T16:17:00.883707",
     "exception": false,
     "start_time": "2025-12-31T16:17:00.869916",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# # This Python 3 environment comes with many helpful analytics libraries installed\n",
    "# # It is defined by the kaggle/python Docker image: https://github.com/kaggle/docker-python\n",
    "# # For example, here's several helpful packages to load\n",
    "\n",
    "# import numpy as np # linear algebra\n",
    "# import pandas as pd # data processing, CSV file I/O (e.g. pd.read_csv)\n",
    "\n",
    "# # Input data files are available in the read-only \"../input/\" directory\n",
    "# # For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n",
    "\n",
    "# import os\n",
    "# for dirname, _, filenames in os.walk('/kaggle/input'):\n",
    "#     for filename in filenames:\n",
    "#         print(os.path.join(dirname, filename))\n",
    "\n",
    "# # You can write up to 20GB to the current directory (/kaggle/working/) that gets preserved as output when you create a version using \"Save & Run All\" \n",
    "# # You can also write temporary files to /kaggle/temp/, but they won't be saved outside of the current session"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "81c490f3",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-12-31T16:17:00.889815Z",
     "iopub.status.busy": "2025-12-31T16:17:00.888995Z",
     "iopub.status.idle": "2025-12-31T16:17:03.680920Z",
     "shell.execute_reply": "2025-12-31T16:17:03.679781Z"
    },
    "papermill": {
     "duration": 2.797338,
     "end_time": "2025-12-31T16:17:03.683137",
     "exception": false,
     "start_time": "2025-12-31T16:17:00.885799",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>path</th>\n",
       "      <th>event_type_code</th>\n",
       "      <th>file</th>\n",
       "      <th>source</th>\n",
       "      <th>well_id</th>\n",
       "      <th>run_ts</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>/kaggle/input/3w-dataset/2.0.0/0/WELL-00001_20...</td>\n",
       "      <td>0</td>\n",
       "      <td>WELL-00001_20170201010207.parquet</td>\n",
       "      <td>WELL</td>\n",
       "      <td>WELL-00001</td>\n",
       "      <td>2017-02-01 01:02:07</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>/kaggle/input/3w-dataset/2.0.0/0/WELL-00001_20...</td>\n",
       "      <td>0</td>\n",
       "      <td>WELL-00001_20170201060114.parquet</td>\n",
       "      <td>WELL</td>\n",
       "      <td>WELL-00001</td>\n",
       "      <td>2017-02-01 06:01:14</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>/kaggle/input/3w-dataset/2.0.0/0/WELL-00001_20...</td>\n",
       "      <td>0</td>\n",
       "      <td>WELL-00001_20170201110124.parquet</td>\n",
       "      <td>WELL</td>\n",
       "      <td>WELL-00001</td>\n",
       "      <td>2017-02-01 11:01:24</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>/kaggle/input/3w-dataset/2.0.0/0/WELL-00001_20...</td>\n",
       "      <td>0</td>\n",
       "      <td>WELL-00001_20170201160311.parquet</td>\n",
       "      <td>WELL</td>\n",
       "      <td>WELL-00001</td>\n",
       "      <td>2017-02-01 16:03:11</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>/kaggle/input/3w-dataset/2.0.0/0/WELL-00001_20...</td>\n",
       "      <td>0</td>\n",
       "      <td>WELL-00001_20170201210228.parquet</td>\n",
       "      <td>WELL</td>\n",
       "      <td>WELL-00001</td>\n",
       "      <td>2017-02-01 21:02:28</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                                                path  event_type_code  \\\n",
       "0  /kaggle/input/3w-dataset/2.0.0/0/WELL-00001_20...                0   \n",
       "1  /kaggle/input/3w-dataset/2.0.0/0/WELL-00001_20...                0   \n",
       "2  /kaggle/input/3w-dataset/2.0.0/0/WELL-00001_20...                0   \n",
       "3  /kaggle/input/3w-dataset/2.0.0/0/WELL-00001_20...                0   \n",
       "4  /kaggle/input/3w-dataset/2.0.0/0/WELL-00001_20...                0   \n",
       "\n",
       "                                file source     well_id              run_ts  \n",
       "0  WELL-00001_20170201010207.parquet   WELL  WELL-00001 2017-02-01 01:02:07  \n",
       "1  WELL-00001_20170201060114.parquet   WELL  WELL-00001 2017-02-01 06:01:14  \n",
       "2  WELL-00001_20170201110124.parquet   WELL  WELL-00001 2017-02-01 11:01:24  \n",
       "3  WELL-00001_20170201160311.parquet   WELL  WELL-00001 2017-02-01 16:03:11  \n",
       "4  WELL-00001_20170201210228.parquet   WELL  WELL-00001 2017-02-01 21:02:28  "
      ]
     },
     "execution_count": 2,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "import os, re\n",
    "import numpy as np\n",
    "import pandas as pd\n",
    "from tqdm.auto import tqdm\n",
    "\n",
    "BASE = \"/kaggle/input/3w-dataset/2.0.0\"\n",
    "RANDOM_STATE = 42\n",
    "\n",
    "def build_file_index(base: str) -> pd.DataFrame:\n",
    "    paths = []\n",
    "    for root, _, files in os.walk(base):\n",
    "        for f in files:\n",
    "            if f.endswith(\".parquet\"):\n",
    "                paths.append(os.path.join(root, f))\n",
    "\n",
    "    df = pd.DataFrame({\"path\": paths})\n",
    "\n",
    "    df[\"event_type_code\"] = df[\"path\"].str.extract(r\"/2\\.0\\.0/(\\d+)/\").astype(int)\n",
    "    df[\"file\"] = df[\"path\"].str.split(\"/\").str[-1]\n",
    "    df[\"source\"] = df[\"file\"].str.extract(r\"^(WELL|SIMULATED|DRAWN)\")\n",
    "    df[\"well_id\"] = df[\"file\"].str.extract(r\"(WELL-\\d+)\")\n",
    "    df[\"run_ts\"] = df[\"file\"].str.extract(r\"_(\\d{14})\")\n",
    "    df[\"run_ts\"] = pd.to_datetime(df[\"run_ts\"], format=\"%Y%m%d%H%M%S\", errors=\"coerce\")\n",
    "\n",
    "    df = df.sort_values([\"event_type_code\",\"source\",\"well_id\",\"run_ts\"]).reset_index(drop=True)\n",
    "    return df\n",
    "\n",
    "df_files = build_file_index(BASE)\n",
    "df_files.head()\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "abde0669",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-12-31T16:17:03.689804Z",
     "iopub.status.busy": "2025-12-31T16:17:03.689172Z",
     "iopub.status.idle": "2025-12-31T16:17:03.707569Z",
     "shell.execute_reply": "2025-12-31T16:17:03.706577Z"
    },
    "papermill": {
     "duration": 0.024027,
     "end_time": "2025-12-31T16:17:03.709642",
     "exception": false,
     "start_time": "2025-12-31T16:17:03.685615",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Num files: 2228\n"
     ]
    },
    {
     "data": {
      "text/plain": [
       "source\n",
       "WELL         1119\n",
       "SIMULATED    1089\n",
       "DRAWN          20\n",
       "Name: count, dtype: int64"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "text/plain": [
       "event_type_code\n",
       "0    594\n",
       "1    128\n",
       "2     38\n",
       "3    106\n",
       "4    343\n",
       "5    450\n",
       "6    221\n",
       "7     46\n",
       "8     95\n",
       "9    207\n",
       "Name: count, dtype: int64"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "print(\"Num files:\", len(df_files))\n",
    "display(df_files[\"source\"].value_counts(dropna=False))\n",
    "display(df_files[\"event_type_code\"].value_counts().sort_index())\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "c4cb340f",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-12-31T16:17:03.716985Z",
     "iopub.status.busy": "2025-12-31T16:17:03.716067Z",
     "iopub.status.idle": "2025-12-31T16:17:03.726764Z",
     "shell.execute_reply": "2025-12-31T16:17:03.725697Z"
    },
    "papermill": {
     "duration": 0.016603,
     "end_time": "2025-12-31T16:17:03.728853",
     "exception": false,
     "start_time": "2025-12-31T16:17:03.712250",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "VAR_RENAME = {\n",
    "    \"ABER-CKGL\": \"gl_choke_opening_pct\",\n",
    "    \"ABER-CKP\":  \"prod_choke_opening_pct\",\n",
    "    \"ESTADO-DHSV\":   \"dhsv_state\",\n",
    "    \"ESTADO-M1\":     \"prod_master_valve_state\",\n",
    "    \"ESTADO-M2\":     \"ann_master_valve_state\",\n",
    "    \"ESTADO-PXO\":    \"pig_crossover_valve_state\",\n",
    "    \"ESTADO-SDV-GL\": \"gl_shutdown_valve_state\",\n",
    "    \"ESTADO-SDV-P\":  \"prod_shutdown_valve_state\",\n",
    "    \"ESTADO-W1\":     \"prod_wing_valve_state\",\n",
    "    \"ESTADO-W2\":     \"ann_wing_valve_state\",\n",
    "    \"ESTADO-XO\":     \"crossover_valve_state\",\n",
    "    \"P-ANULAR\":     \"annulus_pressure_pa\",\n",
    "    \"P-JUS-BS\":     \"svc_pump_downstream_pressure_pa\",\n",
    "    \"P-JUS-CKGL\":   \"gl_choke_downstream_pressure_pa\",\n",
    "    \"P-JUS-CKP\":    \"prod_choke_downstream_pressure_pa\",\n",
    "    \"P-MON-CKGL\":   \"gl_choke_upstream_pressure_pa\",\n",
    "    \"P-MON-CKP\":    \"prod_choke_upstream_pressure_pa\",\n",
    "    \"P-MON-SDV-P\":  \"prod_sdv_upstream_pressure_pa\",\n",
    "    \"P-PDG\":        \"pdg_downhole_pressure_pa\",\n",
    "    \"PT-P\":         \"xmas_tree_prod_line_pressure_pa\",\n",
    "    \"P-TPT\":        \"tpt_pressure_pa\",\n",
    "    \"QBS\": \"svc_pump_flow_m3s\",\n",
    "    \"QGL\": \"gas_lift_flow_m3s\",\n",
    "    \"T-JUS-CKP\": \"prod_choke_downstream_temp_c\",\n",
    "    \"T-MON-CKP\": \"prod_choke_upstream_temp_c\",\n",
    "    \"T-PDG\":     \"pdg_downhole_temp_c\",\n",
    "    \"T-TPT\":     \"tpt_temp_c\",\n",
    "    \"class\": \"class_code\",\n",
    "    \"state\": \"state_code\",\n",
    "}\n",
    "\n",
    "EVENT_TYPE_CODE_TO_NAME = {\n",
    "    0:\"Normal Operation\", 1:\"Abrupt Increase of BSW\", 2:\"Spurious Closure of DHSV\",\n",
    "    3:\"Severe Slugging\", 4:\"Flow Instability\", 5:\"Rapid Productivity Loss\",\n",
    "    6:\"Quick Restriction in PCK\", 7:\"Scaling in PCK\",\n",
    "    8:\"Hydrate in Production Line\", 9:\"Hydrate in Service Line\",\n",
    "}\n",
    "\n",
    "LABEL_COLS = {\"class_code\", \"state_code\", \"class_label\", \"state_label\"}\n",
    "\n",
    "def clean_3w_instance(df: pd.DataFrame) -> pd.DataFrame:\n",
    "    df = df.copy()\n",
    "\n",
    "    # Ensure timestamp index سواء كان index أو column\n",
    "    if \"timestamp\" in df.columns:\n",
    "        df[\"timestamp\"] = pd.to_datetime(df[\"timestamp\"], errors=\"coerce\")\n",
    "        df = df.set_index(\"timestamp\")\n",
    "    else:\n",
    "        df.index = pd.to_datetime(df.index, errors=\"coerce\")\n",
    "\n",
    "    df = df[~df.index.isna()].sort_index()\n",
    "    df.index.name = \"timestamp\"\n",
    "\n",
    "    # rename\n",
    "    df = df.rename(columns=VAR_RENAME)\n",
    "\n",
    "    # numeric coercion\n",
    "    for c in df.columns:\n",
    "        if c in (\"class_code\", \"state_code\"):\n",
    "            df[c] = pd.to_numeric(df[c], errors=\"coerce\").astype(\"Int16\")\n",
    "        else:\n",
    "            df[c] = pd.to_numeric(df[c], errors=\"coerce\").astype(\"float32\")\n",
    "\n",
    "    return df\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "2a2a035b",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-12-31T16:17:03.736131Z",
     "iopub.status.busy": "2025-12-31T16:17:03.735343Z",
     "iopub.status.idle": "2025-12-31T16:17:03.743566Z",
     "shell.execute_reply": "2025-12-31T16:17:03.742620Z"
    },
    "papermill": {
     "duration": 0.014225,
     "end_time": "2025-12-31T16:17:03.745621",
     "exception": false,
     "start_time": "2025-12-31T16:17:03.731396",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "def summarize_timeseries_fast(df_clean: pd.DataFrame) -> dict:\n",
    "    sensors = df_clean.drop(columns=list(LABEL_COLS), errors=\"ignore\")\n",
    "    num = sensors.select_dtypes(include=[np.number])\n",
    "\n",
    "    out = {\n",
    "        \"n_obs\": int(len(df_clean)),\n",
    "        \"duration_s\": float((df_clean.index.max() - df_clean.index.min()).total_seconds())\n",
    "                      if len(df_clean) else np.nan,\n",
    "    }\n",
    "\n",
    "    if num.shape[1] == 0 or len(num) == 0:\n",
    "        return out\n",
    "\n",
    "    agg = num.agg([\"mean\", \"std\", \"min\", \"max\"]).T\n",
    "    last = num.iloc[-1]\n",
    "    miss = num.isna().mean()\n",
    "    frozen = (num.nunique(dropna=True) <= 1).astype(\"int8\")\n",
    "\n",
    "    for col in num.columns:\n",
    "        out[f\"{col}__mean\"] = agg.loc[col, \"mean\"]\n",
    "        out[f\"{col}__std\"]  = agg.loc[col, \"std\"]\n",
    "        out[f\"{col}__min\"]  = agg.loc[col, \"min\"]\n",
    "        out[f\"{col}__max\"]  = agg.loc[col, \"max\"]\n",
    "        out[f\"{col}__last\"] = last[col]\n",
    "        out[f\"{col}__missing_frac\"] = miss[col]\n",
    "        out[f\"{col}__is_frozen\"] = int(frozen[col])\n",
    "\n",
    "    return out\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "d1f2822d",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-12-31T16:17:03.752207Z",
     "iopub.status.busy": "2025-12-31T16:17:03.751247Z",
     "iopub.status.idle": "2025-12-31T16:17:26.260514Z",
     "shell.execute_reply": "2025-12-31T16:17:26.259551Z"
    },
    "papermill": {
     "duration": 22.514744,
     "end_time": "2025-12-31T16:17:26.262715",
     "exception": false,
     "start_time": "2025-12-31T16:17:03.747971",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "1ef45d5c2fe84988b4e9d7589a3f3f8a",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "Building row-per-file dataset:   0%|          | 0/200 [00:00<?, ?it/s]"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>n_obs</th>\n",
       "      <th>duration_s</th>\n",
       "      <th>gl_choke_opening_pct__mean</th>\n",
       "      <th>gl_choke_opening_pct__std</th>\n",
       "      <th>gl_choke_opening_pct__min</th>\n",
       "      <th>gl_choke_opening_pct__max</th>\n",
       "      <th>gl_choke_opening_pct__last</th>\n",
       "      <th>gl_choke_opening_pct__missing_frac</th>\n",
       "      <th>gl_choke_opening_pct__is_frozen</th>\n",
       "      <th>prod_choke_opening_pct__mean</th>\n",
       "      <th>...</th>\n",
       "      <th>tpt_temp_c__max</th>\n",
       "      <th>tpt_temp_c__last</th>\n",
       "      <th>tpt_temp_c__missing_frac</th>\n",
       "      <th>tpt_temp_c__is_frozen</th>\n",
       "      <th>event_type_code</th>\n",
       "      <th>event_type_name</th>\n",
       "      <th>source</th>\n",
       "      <th>well_id</th>\n",
       "      <th>run_ts</th>\n",
       "      <th>file</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>21421</td>\n",
       "      <td>21420.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>1.0</td>\n",
       "      <td>1</td>\n",
       "      <td>NaN</td>\n",
       "      <td>...</td>\n",
       "      <td>116.793701</td>\n",
       "      <td>116.685699</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>Normal Operation</td>\n",
       "      <td>WELL</td>\n",
       "      <td>WELL-00001</td>\n",
       "      <td>2017-05-27 15:00:00</td>\n",
       "      <td>WELL-00001_20170527150000.parquet</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>21355</td>\n",
       "      <td>21354.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>1.0</td>\n",
       "      <td>1</td>\n",
       "      <td>NaN</td>\n",
       "      <td>...</td>\n",
       "      <td>116.520302</td>\n",
       "      <td>116.417702</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>Normal Operation</td>\n",
       "      <td>WELL</td>\n",
       "      <td>WELL-00006</td>\n",
       "      <td>2017-08-20 00:00:00</td>\n",
       "      <td>WELL-00006_20170820000000.parquet</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>26999</td>\n",
       "      <td>26998.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>1.0</td>\n",
       "      <td>1</td>\n",
       "      <td>NaN</td>\n",
       "      <td>...</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>1.000000</td>\n",
       "      <td>1</td>\n",
       "      <td>6</td>\n",
       "      <td>Quick Restriction in PCK</td>\n",
       "      <td>SIMULATED</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaT</td>\n",
       "      <td>SIMULATED_00138.parquet</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>21470</td>\n",
       "      <td>21469.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>1.0</td>\n",
       "      <td>1</td>\n",
       "      <td>NaN</td>\n",
       "      <td>...</td>\n",
       "      <td>118.707703</td>\n",
       "      <td>118.698502</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>Normal Operation</td>\n",
       "      <td>WELL</td>\n",
       "      <td>WELL-00002</td>\n",
       "      <td>2017-06-18 16:02:11</td>\n",
       "      <td>WELL-00002_20170618160211.parquet</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>30601</td>\n",
       "      <td>30600.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>1.0</td>\n",
       "      <td>1</td>\n",
       "      <td>NaN</td>\n",
       "      <td>...</td>\n",
       "      <td>111.813499</td>\n",
       "      <td>3.275891</td>\n",
       "      <td>0.064736</td>\n",
       "      <td>0</td>\n",
       "      <td>2</td>\n",
       "      <td>Spurious Closure of DHSV</td>\n",
       "      <td>WELL</td>\n",
       "      <td>WELL-00011</td>\n",
       "      <td>2014-05-15 08:30:00</td>\n",
       "      <td>WELL-00011_20140515083000.parquet</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>5 rows × 197 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "   n_obs  duration_s  gl_choke_opening_pct__mean  gl_choke_opening_pct__std  \\\n",
       "0  21421     21420.0                         NaN                        NaN   \n",
       "1  21355     21354.0                         NaN                        NaN   \n",
       "2  26999     26998.0                         NaN                        NaN   \n",
       "3  21470     21469.0                         NaN                        NaN   \n",
       "4  30601     30600.0                         NaN                        NaN   \n",
       "\n",
       "   gl_choke_opening_pct__min  gl_choke_opening_pct__max  \\\n",
       "0                        NaN                        NaN   \n",
       "1                        NaN                        NaN   \n",
       "2                        NaN                        NaN   \n",
       "3                        NaN                        NaN   \n",
       "4                        NaN                        NaN   \n",
       "\n",
       "   gl_choke_opening_pct__last  gl_choke_opening_pct__missing_frac  \\\n",
       "0                         NaN                                 1.0   \n",
       "1                         NaN                                 1.0   \n",
       "2                         NaN                                 1.0   \n",
       "3                         NaN                                 1.0   \n",
       "4                         NaN                                 1.0   \n",
       "\n",
       "   gl_choke_opening_pct__is_frozen  prod_choke_opening_pct__mean  ...  \\\n",
       "0                                1                           NaN  ...   \n",
       "1                                1                           NaN  ...   \n",
       "2                                1                           NaN  ...   \n",
       "3                                1                           NaN  ...   \n",
       "4                                1                           NaN  ...   \n",
       "\n",
       "   tpt_temp_c__max  tpt_temp_c__last  tpt_temp_c__missing_frac  \\\n",
       "0       116.793701        116.685699                  0.000000   \n",
       "1       116.520302        116.417702                  0.000000   \n",
       "2              NaN               NaN                  1.000000   \n",
       "3       118.707703        118.698502                  0.000000   \n",
       "4       111.813499          3.275891                  0.064736   \n",
       "\n",
       "   tpt_temp_c__is_frozen  event_type_code           event_type_name  \\\n",
       "0                      0                0          Normal Operation   \n",
       "1                      0                0          Normal Operation   \n",
       "2                      1                6  Quick Restriction in PCK   \n",
       "3                      0                0          Normal Operation   \n",
       "4                      0                2  Spurious Closure of DHSV   \n",
       "\n",
       "      source     well_id              run_ts  \\\n",
       "0       WELL  WELL-00001 2017-05-27 15:00:00   \n",
       "1       WELL  WELL-00006 2017-08-20 00:00:00   \n",
       "2  SIMULATED         NaN                 NaT   \n",
       "3       WELL  WELL-00002 2017-06-18 16:02:11   \n",
       "4       WELL  WELL-00011 2014-05-15 08:30:00   \n",
       "\n",
       "                                file  \n",
       "0  WELL-00001_20170527150000.parquet  \n",
       "1  WELL-00006_20170820000000.parquet  \n",
       "2            SIMULATED_00138.parquet  \n",
       "3  WELL-00002_20170618160211.parquet  \n",
       "4  WELL-00011_20140515083000.parquet  \n",
       "\n",
       "[5 rows x 197 columns]"
      ]
     },
     "execution_count": 6,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "def build_row_per_file_dataset(df_files: pd.DataFrame, n_files: int = 500, random_state: int = 42) -> pd.DataFrame:\n",
    "    sample = df_files.sample(n_files, random_state=random_state).reset_index(drop=True)\n",
    "\n",
    "    rows = []\n",
    "    for _, r in tqdm(sample.iterrows(), total=len(sample), desc=\"Building row-per-file dataset\"):\n",
    "        df_raw = pd.read_parquet(r[\"path\"])\n",
    "        df_clean = clean_3w_instance(df_raw)\n",
    "\n",
    "        feats = summarize_timeseries_fast(df_clean)\n",
    "\n",
    "        feats[\"event_type_code\"] = int(r[\"event_type_code\"])\n",
    "        feats[\"event_type_name\"] = EVENT_TYPE_CODE_TO_NAME.get(int(r[\"event_type_code\"]), \"Unknown\")\n",
    "        feats[\"source\"] = r[\"source\"]\n",
    "        feats[\"well_id\"] = r[\"well_id\"]\n",
    "        feats[\"run_ts\"] = r[\"run_ts\"]\n",
    "        feats[\"file\"] = r[\"file\"]\n",
    "        rows.append(feats)\n",
    "\n",
    "    return pd.DataFrame(rows)\n",
    "\n",
    "df_ml = build_row_per_file_dataset(df_files, n_files=200, random_state=RANDOM_STATE)\n",
    "df_ml.head()\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "be90b16a",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-12-31T16:17:26.270032Z",
     "iopub.status.busy": "2025-12-31T16:17:26.269605Z",
     "iopub.status.idle": "2025-12-31T16:17:26.278881Z",
     "shell.execute_reply": "2025-12-31T16:17:26.277703Z"
    },
    "papermill": {
     "duration": 0.015186,
     "end_time": "2025-12-31T16:17:26.280937",
     "exception": false,
     "start_time": "2025-12-31T16:17:26.265751",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "(200, 197)\n"
     ]
    },
    {
     "data": {
      "text/plain": [
       "event_type_name\n",
       "Normal Operation              64\n",
       "Rapid Productivity Loss       42\n",
       "Flow Instability              25\n",
       "Hydrate in Service Line       21\n",
       "Quick Restriction in PCK      15\n",
       "Abrupt Increase of BSW        11\n",
       "Severe Slugging               10\n",
       "Hydrate in Production Line     7\n",
       "Scaling in PCK                 4\n",
       "Spurious Closure of DHSV       1\n",
       "Name: count, dtype: int64"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "print(df_ml.shape)\n",
    "display(df_ml[\"event_type_name\"].value_counts())\n"
   ]
  }
 ],
 "metadata": {
  "kaggle": {
   "accelerator": "none",
   "dataSources": [
    {
     "datasetId": 988298,
     "sourceId": 9353254,
     "sourceType": "datasetVersion"
    }
   ],
   "dockerImageVersionId": 31234,
   "isGpuEnabled": false,
   "isInternetEnabled": true,
   "language": "python",
   "sourceType": "notebook"
  },
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.12.12"
  },
  "papermill": {
   "default_parameters": {},
   "duration": 29.529719,
   "end_time": "2025-12-31T16:17:27.006334",
   "environment_variables": {},
   "exception": null,
   "input_path": "__notebook__.ipynb",
   "output_path": "__notebook__.ipynb",
   "parameters": {},
   "start_time": "2025-12-31T16:16:57.476615",
   "version": "2.6.0"
  },
  "widgets": {
   "application/vnd.jupyter.widget-state+json": {
    "state": {
     "1ef45d5c2fe84988b4e9d7589a3f3f8a": {
      "model_module": "@jupyter-widgets/controls",
      "model_module_version": "2.0.0",
      "model_name": "HBoxModel",
      "state": {
       "_dom_classes": [],
       "_model_module": "@jupyter-widgets/controls",
       "_model_module_version": "2.0.0",
       "_model_name": "HBoxModel",
       "_view_count": null,
       "_view_module": "@jupyter-widgets/controls",
       "_view_module_version": "2.0.0",
       "_view_name": "HBoxView",
       "box_style": "",
       "children": [
        "IPY_MODEL_90b0a648967041b5852029a92b392cd2",
        "IPY_MODEL_dc2183d8b5ef46339bdd75a3ee2e32c7",
        "IPY_MODEL_60c8e5de117f4fa48125ba76fdae404e"
       ],
       "layout": "IPY_MODEL_af88508a883d45599237866e5f315ea2",
       "tabbable": null,
       "tooltip": null
      }
     },
     "2cddb9187fa149baa31606c6c326fe2a": {
      "model_module": "@jupyter-widgets/controls",
      "model_module_version": "2.0.0",
      "model_name": "HTMLStyleModel",
      "state": {
       "_model_module": "@jupyter-widgets/controls",
       "_model_module_version": "2.0.0",
       "_model_name": "HTMLStyleModel",
       "_view_count": null,
       "_view_module": "@jupyter-widgets/base",
       "_view_module_version": "2.0.0",
       "_view_name": "StyleView",
       "background": null,
       "description_width": "",
       "font_size": null,
       "text_color": null
      }
     },
     "3274bcaad2cb46d3860bf423d49b1e61": {
      "model_module": "@jupyter-widgets/controls",
      "model_module_version": "2.0.0",
      "model_name": "ProgressStyleModel",
      "state": {
       "_model_module": "@jupyter-widgets/controls",
       "_model_module_version": "2.0.0",
       "_model_name": "ProgressStyleModel",
       "_view_count": null,
       "_view_module": "@jupyter-widgets/base",
       "_view_module_version": "2.0.0",
       "_view_name": "StyleView",
       "bar_color": null,
       "description_width": ""
      }
     },
     "60c8e5de117f4fa48125ba76fdae404e": {
      "model_module": "@jupyter-widgets/controls",
      "model_module_version": "2.0.0",
      "model_name": "HTMLModel",
      "state": {
       "_dom_classes": [],
       "_model_module": "@jupyter-widgets/controls",
       "_model_module_version": "2.0.0",
       "_model_name": "HTMLModel",
       "_view_count": null,
       "_view_module": "@jupyter-widgets/controls",
       "_view_module_version": "2.0.0",
       "_view_name": "HTMLView",
       "description": "",
       "description_allow_html": false,
       "layout": "IPY_MODEL_cde1eef7da434c399e1359fed8bd6556",
       "placeholder": "​",
       "style": "IPY_MODEL_2cddb9187fa149baa31606c6c326fe2a",
       "tabbable": null,
       "tooltip": null,
       "value": " 200/200 [00:22&lt;00:00, 11.02it/s]"
      }
     },
     "7c1c3a31ad574511b0de4201ebdaa0ea": {
      "model_module": "@jupyter-widgets/controls",
      "model_module_version": "2.0.0",
      "model_name": "HTMLStyleModel",
      "state": {
       "_model_module": "@jupyter-widgets/controls",
       "_model_module_version": "2.0.0",
       "_model_name": "HTMLStyleModel",
       "_view_count": null,
       "_view_module": "@jupyter-widgets/base",
       "_view_module_version": "2.0.0",
       "_view_name": "StyleView",
       "background": null,
       "description_width": "",
       "font_size": null,
       "text_color": null
      }
     },
     "90b0a648967041b5852029a92b392cd2": {
      "model_module": "@jupyter-widgets/controls",
      "model_module_version": "2.0.0",
      "model_name": "HTMLModel",
      "state": {
       "_dom_classes": [],
       "_model_module": "@jupyter-widgets/controls",
       "_model_module_version": "2.0.0",
       "_model_name": "HTMLModel",
       "_view_count": null,
       "_view_module": "@jupyter-widgets/controls",
       "_view_module_version": "2.0.0",
       "_view_name": "HTMLView",
       "description": "",
       "description_allow_html": false,
       "layout": "IPY_MODEL_f29d5c2069c042e3bc42f4f27df5773f",
       "placeholder": "​",
       "style": "IPY_MODEL_7c1c3a31ad574511b0de4201ebdaa0ea",
       "tabbable": null,
       "tooltip": null,
       "value": "Building row-per-file dataset: 100%"
      }
     },
     "a86c04f3d14f4b3695959cc330c27fbc": {
      "model_module": "@jupyter-widgets/base",
      "model_module_version": "2.0.0",
      "model_name": "LayoutModel",
      "state": {
       "_model_module": "@jupyter-widgets/base",
       "_model_module_version": "2.0.0",
       "_model_name": "LayoutModel",
       "_view_count": null,
       "_view_module": "@jupyter-widgets/base",
       "_view_module_version": "2.0.0",
       "_view_name": "LayoutView",
       "align_content": null,
       "align_items": null,
       "align_self": null,
       "border_bottom": null,
       "border_left": null,
       "border_right": null,
       "border_top": null,
       "bottom": null,
       "display": null,
       "flex": null,
       "flex_flow": null,
       "grid_area": null,
       "grid_auto_columns": null,
       "grid_auto_flow": null,
       "grid_auto_rows": null,
       "grid_column": null,
       "grid_gap": null,
       "grid_row": null,
       "grid_template_areas": null,
       "grid_template_columns": null,
       "grid_template_rows": null,
       "height": null,
       "justify_content": null,
       "justify_items": null,
       "left": null,
       "margin": null,
       "max_height": null,
       "max_width": null,
       "min_height": null,
       "min_width": null,
       "object_fit": null,
       "object_position": null,
       "order": null,
       "overflow": null,
       "padding": null,
       "right": null,
       "top": null,
       "visibility": null,
       "width": null
      }
     },
     "af88508a883d45599237866e5f315ea2": {
      "model_module": "@jupyter-widgets/base",
      "model_module_version": "2.0.0",
      "model_name": "LayoutModel",
      "state": {
       "_model_module": "@jupyter-widgets/base",
       "_model_module_version": "2.0.0",
       "_model_name": "LayoutModel",
       "_view_count": null,
       "_view_module": "@jupyter-widgets/base",
       "_view_module_version": "2.0.0",
       "_view_name": "LayoutView",
       "align_content": null,
       "align_items": null,
       "align_self": null,
       "border_bottom": null,
       "border_left": null,
       "border_right": null,
       "border_top": null,
       "bottom": null,
       "display": null,
       "flex": null,
       "flex_flow": null,
       "grid_area": null,
       "grid_auto_columns": null,
       "grid_auto_flow": null,
       "grid_auto_rows": null,
       "grid_column": null,
       "grid_gap": null,
       "grid_row": null,
       "grid_template_areas": null,
       "grid_template_columns": null,
       "grid_template_rows": null,
       "height": null,
       "justify_content": null,
       "justify_items": null,
       "left": null,
       "margin": null,
       "max_height": null,
       "max_width": null,
       "min_height": null,
       "min_width": null,
       "object_fit": null,
       "object_position": null,
       "order": null,
       "overflow": null,
       "padding": null,
       "right": null,
       "top": null,
       "visibility": null,
       "width": null
      }
     },
     "cde1eef7da434c399e1359fed8bd6556": {
      "model_module": "@jupyter-widgets/base",
      "model_module_version": "2.0.0",
      "model_name": "LayoutModel",
      "state": {
       "_model_module": "@jupyter-widgets/base",
       "_model_module_version": "2.0.0",
       "_model_name": "LayoutModel",
       "_view_count": null,
       "_view_module": "@jupyter-widgets/base",
       "_view_module_version": "2.0.0",
       "_view_name": "LayoutView",
       "align_content": null,
       "align_items": null,
       "align_self": null,
       "border_bottom": null,
       "border_left": null,
       "border_right": null,
       "border_top": null,
       "bottom": null,
       "display": null,
       "flex": null,
       "flex_flow": null,
       "grid_area": null,
       "grid_auto_columns": null,
       "grid_auto_flow": null,
       "grid_auto_rows": null,
       "grid_column": null,
       "grid_gap": null,
       "grid_row": null,
       "grid_template_areas": null,
       "grid_template_columns": null,
       "grid_template_rows": null,
       "height": null,
       "justify_content": null,
       "justify_items": null,
       "left": null,
       "margin": null,
       "max_height": null,
       "max_width": null,
       "min_height": null,
       "min_width": null,
       "object_fit": null,
       "object_position": null,
       "order": null,
       "overflow": null,
       "padding": null,
       "right": null,
       "top": null,
       "visibility": null,
       "width": null
      }
     },
     "dc2183d8b5ef46339bdd75a3ee2e32c7": {
      "model_module": "@jupyter-widgets/controls",
      "model_module_version": "2.0.0",
      "model_name": "FloatProgressModel",
      "state": {
       "_dom_classes": [],
       "_model_module": "@jupyter-widgets/controls",
       "_model_module_version": "2.0.0",
       "_model_name": "FloatProgressModel",
       "_view_count": null,
       "_view_module": "@jupyter-widgets/controls",
       "_view_module_version": "2.0.0",
       "_view_name": "ProgressView",
       "bar_style": "success",
       "description": "",
       "description_allow_html": false,
       "layout": "IPY_MODEL_a86c04f3d14f4b3695959cc330c27fbc",
       "max": 200.0,
       "min": 0.0,
       "orientation": "horizontal",
       "style": "IPY_MODEL_3274bcaad2cb46d3860bf423d49b1e61",
       "tabbable": null,
       "tooltip": null,
       "value": 200.0
      }
     },
     "f29d5c2069c042e3bc42f4f27df5773f": {
      "model_module": "@jupyter-widgets/base",
      "model_module_version": "2.0.0",
      "model_name": "LayoutModel",
      "state": {
       "_model_module": "@jupyter-widgets/base",
       "_model_module_version": "2.0.0",
       "_model_name": "LayoutModel",
       "_view_count": null,
       "_view_module": "@jupyter-widgets/base",
       "_view_module_version": "2.0.0",
       "_view_name": "LayoutView",
       "align_content": null,
       "align_items": null,
       "align_self": null,
       "border_bottom": null,
       "border_left": null,
       "border_right": null,
       "border_top": null,
       "bottom": null,
       "display": null,
       "flex": null,
       "flex_flow": null,
       "grid_area": null,
       "grid_auto_columns": null,
       "grid_auto_flow": null,
       "grid_auto_rows": null,
       "grid_column": null,
       "grid_gap": null,
       "grid_row": null,
       "grid_template_areas": null,
       "grid_template_columns": null,
       "grid_template_rows": null,
       "height": null,
       "justify_content": null,
       "justify_items": null,
       "left": null,
       "margin": null,
       "max_height": null,
       "max_width": null,
       "min_height": null,
       "min_width": null,
       "object_fit": null,
       "object_position": null,
       "order": null,
       "overflow": null,
       "padding": null,
       "right": null,
       "top": null,
       "visibility": null,
       "width": null
      }
     }
    },
    "version_major": 2,
    "version_minor": 0
   }
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
